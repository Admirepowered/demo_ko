name: build-gki-ko

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install deps
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          bc \
          bison \
          flex \
          libssl-dev \
          libelf-dev

    - name: Clone Android GKI kernel
      run: |
        git clone --depth=1 https://android.googlesource.com/kernel/common \
          -b android14-6.1 gki

    - name: Prepare GKI config
      run: |
        cd gki
        make ARCH=arm64 gki_defconfig
        make ARCH=arm64 modules_prepare

    - name: Build hello.ko (GKI)
      run: |
        cd gki
        make ARCH=arm64 \
          M=$GITHUB_WORKSPACE/kernel \
          modules

    - name: Upload ko
      uses: actions/upload-artifact@v4
      with:
        name: gki-hello-ko
        path: gki/**/*.ko
